<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desmartin - API Testing Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .section {
            margin-bottom: 40px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #764ba2;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-danger:hover {
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .response-area {
            background: #2d2d2d;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Estilos mejorados para Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f7f7f8;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-area::-webkit-scrollbar {
            width: 8px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chat-area::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-radius: 12px;
            animation: fadeIn 0.3s ease-in;
            max-width: 85%;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.docente {
            background: #ffffff;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }

        .chat-message.ia {
            background: #f0f0f0;
            align-self: flex-start;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #d0d0d0;
        }

        .chat-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .chat-message.docente .chat-message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chat-message.ia .chat-message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .chat-message-content {
            flex: 1;
        }

        .chat-message-text {
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
        }

        .chat-input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input-wrapper {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            min-height: 50px;
            max-height: 150px;
            padding: 12px 50px 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 18px;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-session-setup {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-session-type {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .chat-type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .chat-type-btn.active {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .chat-session-info {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 13px;
            color: #667eea;
        }
        
        .chat-session-reuse {
            background: #e8f5e9;
            border: 2px solid #4caf50;
            color: #2e7d32;
        }
        
        .chat-session-new {
            background: #fff3e0;
            border: 2px solid #ff9800;
            color: #e65100;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-loading {
            display: flex;
            gap: 4px;
            padding: 12px;
            align-items: center;
            color: #999;
        }

        .chat-loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .chat-loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .chat-loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .inline-inputs {
            display: flex;
            gap: 10px;
        }

        .inline-inputs input {
            flex: 1;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Desmartin API Testing Interface</h1>

        <div id="response" class="response-area">Las respuestas aparecer√°n aqu√≠...</div>

        <!-- Autenticaci√≥n -->
        <div class="section">
            <h2>üîê Autenticaci√≥n</h2>
            <div class="grid">
                <div>
                    <h3>Login Admin</h3>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="adminUser" placeholder="admin">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="adminPass" placeholder="admin123">
                    </div>
                    <button onclick="loginAdmin()">Login Admin</button>
                </div>

                <div>
                    <h3>Login Docente</h3>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="docenteUser" placeholder="docente1">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="docentePass" placeholder="docente123">
                    </div>
                    <button onclick="loginDocente()">Login Docente</button>
                </div>

                <div>
                    <h3>Login Alumno</h3>
                    <div class="form-group">
                        <label>Usuario:</label>
                        <input type="text" id="alumnoUser" placeholder="alumno1">
                    </div>
                    <div class="form-group">
                        <label>Contrase√±a:</label>
                        <input type="password" id="alumnoPass" placeholder="alumno123">
                    </div>
                    <button onclick="loginAlumno()">Login Alumno</button>
                </div>
            </div>
        </div>
        <!-- Gesti√≥n de Admin -->
        <div class="section">
            <h2>üë®‚Äçüíº Gesti√≥n de Administradores</h2>
            <div class="form-group">
                <label>Nombre de usuario:</label>
                <input type="text" id="adminNombreUsuario">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="adminContrasena">
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="adminNombre">
            </div>
            <div class="form-group">
                <label>Apellido:</label>
                <input type="text" id="adminApellido">
            </div>
            <button onclick="crearAdmin()">Crear Admin</button>
            <button onclick="listarAdmin()">Listar Admin</button>
            <div class="form-group inline-inputs">
                <input type="number" id="adminId" placeholder="ID para actualizar/eliminar">
                <button onclick="actualizarAdmin()">Actualizar</button>
                <button class="btn-danger" onclick="eliminarAdmin()">Eliminar</button>
                <button onclick="verAdminPorId()">Ver por ID</button>
            </div>
        </div>

        <!-- Gesti√≥n de Docentes -->
        <div class="section">
            <h2>üë®‚Äçüè´ Gesti√≥n de Docentes</h2>
            <div class="form-group">
                <label>Nombre de usuario:</label>
                <input type="text" id="docenteNombreUsuario">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="docenteContrasena">
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="docenteNombre">
            </div>
            <div class="form-group">
                <label>Apellido:</label>
                <input type="text" id="docenteApellido">
            </div>
            <button onclick="crearDocente()">Crear Docente</button>
            <button onclick="listarDocentes()">Listar Docentes</button>
            <div class="form-group inline-inputs">
                <input type="number" id="docenteId" placeholder="ID para actualizar/eliminar">
                <button onclick="actualizarDocente()">Actualizar</button>
                <button class="btn-danger" onclick="eliminarDocente()">Eliminar</button>
                <button onclick="verDocentePorId()">Ver por ID</button>
            </div>
        </div>
        <!-- Gesti√≥n de Alumnos -->
        <div class="section">
            <h2>üë®‚Äçüéì Gesti√≥n de Alumnos</h2>
            <div class="form-group">
                <label>Nombre de usuario:</label>
                <input type="text" id="alumnoNombreUsuario">
            </div>
            <div class="form-group">
                <label>Contrase√±a:</label>
                <input type="password" id="alumnoContrasena">
            </div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="alumnoNombre">
            </div>
            <div class="form-group">
                <label>Apellido:</label>
                <input type="text" id="alumnoApellido">
            </div>
            <div class="form-group">
                <label>Fecha de nacimiento:</label>
                <input type="date" id="alumnoFechaNacimiento">
            </div>
            <button onclick="crearAlumno()">Crear Alumno</button>
            <button onclick="listarAlumnos()">Listar Alumnos</button>
            <div class="form-group inline-inputs">
                <input type="number" id="alumnoId" placeholder="ID para actualizar/eliminar">
                <button onclick="actualizarAlumno()">Actualizar</button>
                <button class="btn-danger" onclick="eliminarAlumno()">Eliminar</button>
                <button onclick="verAlumnoPorId()">Ver por ID</button>
            </div>
        </div>
        <!-- Gesti√≥n de Cursos -->
        <div class="section">
            <h2>üìò Gesti√≥n de Cursos</h2>

            <div class="form-group">
                <label>Nombre del curso:</label>
                <input type="text" id="cursoNombre" placeholder="Ejemplo: Matem√°tica 1">
            </div>
            <div class="form-group">
                <label>Descripci√≥n:</label>
                <input type="text" id="cursoDescripcion" placeholder="Ejemplo: Curso b√°sico de aritm√©tica">
            </div>
            <div class="form-group">
                <label>ID del docente (quien dicta el curso):</label>
                <input type="number" id="cursoDocenteId" placeholder="Ejemplo: 3">
            </div>
            <button onclick="crearCurso()">Crear Curso</button>
            <button onclick="listarCursos()">Listar Todos los Cursos</button>

            <div class="form-group inline-inputs">
                <input type="number" id="cursoId" placeholder="ID curso para actualizar/eliminar">
                <button onclick="actualizarCurso()">Actualizar</button>
                <button class="btn-danger" onclick="eliminarCurso()">Eliminar</button>
            </div>

            <hr>
            <h3>üéì Gesti√≥n de Matr√≠culas</h3>
            <div class="form-group">
                <label>ID Alumno:</label>
                <input type="number" id="matriculaAlumnoId" placeholder="Ejemplo: 5">
            </div>
            <div class="form-group">
                <label>ID Curso:</label>
                <input type="number" id="matriculaCursoId" placeholder="Ejemplo: 2">
            </div>
            <button onclick="matricularAlumno()">Matricular Alumno</button>

            <hr>
            <h3>üîç Consultas Espec√≠ficas</h3>
            <div class="form-group inline-inputs">
                <input type="number" id="docenteCursoId" placeholder="ID Docente">
                <button onclick="listarCursosDocente()">Listar Cursos de Docente</button>
            </div>

            <div class="form-group inline-inputs">
                <input type="number" id="cursoAlumnosId" placeholder="ID Curso">
                <button onclick="listarAlumnosCurso()">Listar Alumnos del Curso</button>
            </div>

            <div class="form-group inline-inputs">
                <input type="number" id="alumnoCursosId" placeholder="ID Alumno">
                <button onclick="listarCursosAlumno()">Listar Cursos del Alumno</button>
            </div>

            <div class="form-group inline-inputs">
                <input type="number" id="docenteAlumnosId" placeholder="ID Docente">
                <button onclick="listarAlumnosDocente()">Listar Alumnos del Docente</button>
            </div>
        </div>


        <!-- Test de Inteligencia -->
        <div class="section">
            <h2>üß† Test de Inteligencia</h2>
            <button onclick="obtenerPreguntas()">Obtener Preguntas</button>
            <div class="form-group">
                <label>ID Alumno:</label>
                <input type="number" id="testAlumnoId" placeholder="1">
            </div>
            <div class="form-group">
                <label>Respuestas (JSON):</label>
                <textarea id="testRespuestas" rows="5" placeholder="[{&quot;idPregunta&quot;: 1, &quot;puntaje&quot;: 5}, {&quot;idPregunta&quot;: 2, &quot;puntaje&quot;: 3}]"></textarea>
            </div>
            <button onclick="completarTest()">Completar Test</button>
        </div>

        <!-- Resultados -->
        <div class="section">
            <h2>üìä Resultados</h2>
            <div class="form-group inline-inputs">
                <input type="number" id="resultadoAlumnoId" placeholder="ID Alumno">
                <button onclick="obtenerUltimoResultado()">√öltimo Resultado</button>
                <button onclick="obtenerHistorialResultados()">Historial</button>
            </div>
            <button onclick="listarLogs()">Ver Logs de Acceso</button>
            
            <hr style="margin: 20px 0;">
            <h3>üì• Obtener Resultados del Test (Formato para IA)</h3>
            <div class="form-group inline-inputs">
                <input type="number" id="resultadosTestAlumnoId" placeholder="ID Alumno">
                <button onclick="obtenerResultadosTest()">Obtener Resultados</button>
            </div>
            <div id="resultadosTestContainer" style="display: none; margin-top: 15px; padding: 15px; background: #f0f4ff; border-radius: 8px; border: 2px solid #667eea;">
                <h4 style="color: #667eea; margin-bottom: 10px;">üìã Resultados Obtenidos:</h4>
                <pre id="resultadosTestDisplay" style="background: white; padding: 15px; border-radius: 5px; overflow-x: auto; max-height: 300px; overflow-y: auto; font-size: 12px; line-height: 1.5;"></pre>
                <button onclick="copiarResultadosTest()" style="margin-top: 10px; background: #667eea; color: white; padding: 8px 20px; border: none; border-radius: 5px; cursor: pointer;">üìã Copiar JSON</button>
            </div>
            
            <hr style="margin: 20px 0;">
            <h3>üì§ Crear/Guardar Resultados del Test</h3>
            <div class="form-group">
                <label>ID Intento:</label>
                <input type="number" id="crearResultadoIdIntento" placeholder="Ejemplo: 1">
            </div>
            <div class="form-group">
                <label>Resultados (JSON):</label>
                <textarea id="crearResultadoJson" rows="8" placeholder="[{&quot;idInteligencia&quot;: 1, &quot;puntajeCalculado&quot;: 5}, {&quot;idInteligencia&quot;: 2, &quot;puntajeCalculado&quot;: 4.5}]"></textarea>
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                    Formato: Array de objetos con "idInteligencia" y "puntajeCalculado"
                </small>
            </div>
            <button onclick="crearResultadosTest()">üíæ Guardar Resultados</button>
        </div>

        <!-- Chat con IA -->
        <div class="section">
            <h2>üí¨ Chat con IA - DeepSeek</h2>
            
            <!-- Configuraci√≥n de Sesi√≥n -->
            <div class="chat-session-setup">
                <div class="form-group">
                    <label>ID Docente:</label>
                    <input type="number" id="chatDocenteId" placeholder="Ejemplo: 1">
                </div>
                
                <div class="chat-session-type">
                    <button class="chat-type-btn active" id="btnChatIndividual" onclick="seleccionarTipoChat('individual')">
                        üë§ Chat Individual (Alumno)
                    </button>
                    <button class="chat-type-btn" id="btnChatGrupal" onclick="seleccionarTipoChat('grupal')">
                        üë• Chat Grupal (Curso)
                    </button>
                </div>
                
                <div id="chatIndividualConfig">
                    <div class="form-group">
                        <label>ID Alumno:</label>
                        <input type="number" id="chatAlumnoId" placeholder="Ejemplo: 1">
                    </div>
                </div>
                
                <div id="chatGrupalConfig" style="display: none;">
                    <div class="form-group">
                        <label>ID Curso:</label>
                        <input type="number" id="chatCursoId" placeholder="Ejemplo: 1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>T√≠tulo de la Sesi√≥n: <span style="color: #999; font-weight: normal;">(Opcional)</span></label>
                    <input type="text" id="chatTitulo" placeholder="Ejemplo: Consulta sobre resultados del test (opcional)">
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                        üí° <strong>Para chats individuales:</strong> Usa "Cargar √öltima Sesi√≥n" para recuperar autom√°ticamente la √∫ltima conversaci√≥n con el alumno. Usa "Crear Nueva Sesi√≥n" para iniciar una conversaci√≥n nueva.
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="cargarUltimaSesion()" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        üìÇ Cargar √öltima Sesi√≥n
                    </button>
                    <button onclick="crearNuevaSesion()" style="flex: 1;">
                        ‚ûï Crear Nueva Sesi√≥n
                    </button>
                </div>
                
                <div id="chatSessionInfo" class="chat-session-info" style="display: none;">
                    <strong>‚úì Sesi√≥n creada:</strong> <span id="sessionInfoText"></span>
                </div>
                
                <!-- Indicador de reutilizaci√≥n de sesi√≥n -->
                <div id="chatSessionReuseInfo" style="display: none; margin-top: 12px; padding: 12px; border-radius: 8px; font-size: 13px; animation: slideIn 0.3s ease-in;">
                    <span id="sessionReuseText"></span>
                </div>
            </div>
            
            <!-- Chat Container -->
            <div class="chat-container" id="chatContainer" style="display: none;">
                <div class="chat-header">
                    <span id="chatTitle">üí¨ Chat con IA</span>
                    <button onclick="cerrarChat()" style="background: rgba(255,255,255,0.2); padding: 5px 15px; border: none; border-radius: 5px; color: white; cursor: pointer;">Cerrar</button>
                </div>
                
                <div id="chatMessages" class="chat-area">
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <p>üí° Escribe un mensaje para comenzar la conversaci√≥n</p>
                        <p style="font-size: 12px; margin-top: 10px;">La IA responder√° con contexto personalizado del alumno o curso</p>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea 
                            id="mensajeContenido" 
                            class="chat-input" 
                            placeholder="Escribe tu mensaje aqu√≠... (Presiona Enter para enviar, Shift+Enter para nueva l√≠nea)"
                            rows="1"
                            onkeydown="handleChatKeyDown(event)"></textarea>
                        <button class="chat-send-btn" onclick="enviarMensaje()" id="btnEnviarChat" title="Enviar mensaje">
                            ‚û§
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Opciones adicionales -->
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h3 style="font-size: 14px; margin-bottom: 12px; color: #666;">üîß Opciones Adicionales</h3>
                <div class="form-group inline-inputs" style="margin-bottom: 10px;">
                    <input type="number" id="sesionId" placeholder="ID Sesi√≥n existente">
                    <button onclick="cargarSesionExistente()">üìÇ Cargar Sesi√≥n</button>
                    <button onclick="limpiarChat()">üóëÔ∏è Limpiar</button>
                </div>
                
                <hr style="margin: 15px 0;">
                <h4 style="font-size: 13px; margin-bottom: 10px; color: #666;">üìã Consultas de Chat</h4>
                <div class="form-group inline-inputs" style="margin-bottom: 10px;">
                    <input type="number" id="chatDocenteIdConsulta" placeholder="ID Docente">
                    <button onclick="listarSesionesPorDocente()">üìã Listar Sesiones por Docente</button>
                </div>
                <div class="form-group inline-inputs" style="margin-bottom: 10px;">
                    <input type="number" id="chatCursoIdConsulta" placeholder="ID Curso">
                    <button onclick="listarSesionesPorCurso()">üìã Listar Sesiones por Curso</button>
                </div>
                <div class="form-group inline-inputs" style="margin-bottom: 10px;">
                    <input type="number" id="chatAlumnoIdConsulta" placeholder="ID Alumno">
                    <button onclick="listarSesionesPorAlumno()">üìã Listar Sesiones por Alumno</button>
                </div>
                
                <hr style="margin: 15px 0;">
                <h4 style="font-size: 13px; margin-bottom: 10px; color: #666;">‚úèÔ∏è Gesti√≥n de Mensajes</h4>
                <div class="form-group inline-inputs" style="margin-bottom: 10px;">
                    <input type="number" id="mensajeIdEditar" placeholder="ID Mensaje">
                    <input type="text" id="mensajeContenidoEditar" placeholder="Nuevo contenido" style="flex: 2;">
                    <button onclick="actualizarMensajeChat()">‚úèÔ∏è Actualizar Mensaje</button>
                </div>
                <div class="form-group inline-inputs">
                    <input type="number" id="mensajeIdEliminar" placeholder="ID Mensaje">
                    <button class="btn-danger" onclick="eliminarMensajeChat()">üóëÔ∏è Eliminar Mensaje</button>
                </div>
            </div>
        </div>

        <!-- Docente - Resultados de Alumnos -->
        <div class="section">
            <h2>üë®‚Äçüè´ Docente - Resultados de Alumnos</h2>
            <div class="form-group inline-inputs">
                <input type="number" id="docenteResultadoAlumnoId" placeholder="ID Alumno">
                <button onclick="obtenerResultadosAlumnoDocente()">Ver Resultados del Alumno</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8081/api';

        function showResponse(data) {
            document.getElementById('response').textContent = JSON.stringify(data, null, 2);
        }

        async function apiCall(endpoint, method = 'GET', body = null) {
            
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                const response = await fetch(`${API_BASE}${endpoint}`, options);
                
                // Si es 404, retornar null en lugar de error
                if (response.status === 404) {
                    const error = new Error('Not Found');
                    error.status = 404;
                    throw error;
                }
                
                const data = await response.json();
                showResponse(data);
                return data;
            } catch (error) {
                if (error.status === 404) {
                    // Re-lanzar el error con status para que el llamador pueda manejarlo
                    throw error;
                }
                showResponse({ error: error.message });
                throw error;
            }
        }

        // Autenticaci√≥n
        function loginAdmin() {
            const user = document.getElementById('adminUser').value;
            const pass = document.getElementById('adminPass').value;
            apiCall('/auth/login/admin', 'POST', { nombreUsuario: user, contrasena: pass });
        }

        function loginDocente() {
            const user = document.getElementById('docenteUser').value;
            const pass = document.getElementById('docentePass').value;
            apiCall('/auth/login/docente', 'POST', { nombreUsuario: user, contrasena: pass });
        }

        function loginAlumno() {
            const user = document.getElementById('alumnoUser').value;
            const pass = document.getElementById('alumnoPass').value;
            apiCall('/auth/login/alumno', 'POST', { nombreUsuario: user, contrasena: pass });
        }

        // ================= ADMINISTRADORES =================
        function crearAdmin() {
            const usuario = document.getElementById('adminNombreUsuario').value;
            const nombre = document.getElementById('adminNombre').value;
            const apellido = document.getElementById('adminApellido').value;
            const pass = document.getElementById('adminContrasena').value;

            apiCall('/admin/administradores', 'POST', {
                nombreUsuario: usuario,
                contrasena: pass,
                nombre: nombre,
                apellido: apellido
            });
        }

        function listarAdmin() {
            apiCall('/admin/administradores');
        }

        function actualizarAdmin() {
            const id = document.getElementById('adminId').value;
            const usuario = document.getElementById('adminNombreUsuario').value;
            const nombre = document.getElementById('adminNombre').value;
            const apellido = document.getElementById('adminApellido').value;
            const pass = document.getElementById('adminContrasena').value;

            apiCall(`/admin/administradores/${id}`, 'PUT', {
                nombreUsuario: usuario,
                contrasena: pass,
                nombre: nombre,
                apellido: apellido
            });
        }

        function eliminarAdmin() {
            const id = document.getElementById('adminId').value;
            apiCall(`/admin/administradores/${id}`, 'DELETE');
        }

        function verAdminPorId() {
            const id = document.getElementById('adminId').value;
            if (!id) { alert('Ingresa el ID del admin'); return; }
            apiCall(`/admin/administradores/${id}`, 'GET');
        }

        // ================= DOCENTES =================
        function crearDocente() {
            const usuario = document.getElementById('docenteNombreUsuario').value.trim();
            const nombre = document.getElementById('docenteNombre').value.trim();
            const apellido = document.getElementById('docenteApellido').value.trim();
            const pass = document.getElementById('docenteContrasena').value.trim();

            apiCall('/admin/docentes', 'POST', {
                nombreUsuario: usuario,
                contrasena: pass,
                nombre: nombre,
                apellido: apellido
            });
        }

        function listarDocentes() {
            apiCall('/admin/docentes');
        }

        function actualizarDocente() {
            const id = document.getElementById('docenteId').value;
            const usuario = document.getElementById('docenteNombreUsuario').value;
            const nombre = document.getElementById('docenteNombre').value;
            const apellido = document.getElementById('docenteApellido').value;
            const pass = document.getElementById('docenteContrasena').value;

            apiCall(`/admin/docentes/${id}`, 'PUT', {
                nombreUsuario: usuario,
                contrasena: pass,
                nombre: nombre,
                apellido: apellido
            });
        }

        function eliminarDocente() {
            const id = document.getElementById('docenteId').value;
            apiCall(`/admin/docentes/${id}`, 'DELETE');
        }

        function verDocentePorId() {
            const id = document.getElementById('docenteId').value;
            if (!id) { alert('Ingresa el ID del docente'); return; }
            // Preferimos el endpoint espec√≠fico del controlador de docente
            apiCall(`/docente/${id}`, 'GET');
        }

        // ================= ALUMNOS =================
        function crearAlumno() {
            const usuario = document.getElementById('alumnoNombreUsuario').value;
            const nombre = document.getElementById('alumnoNombre').value;
            const apellido = document.getElementById('alumnoApellido').value;
            const fechaNacimiento = document.getElementById('alumnoFechaNacimiento').value;
            const pass = document.getElementById('alumnoContrasena').value;

            apiCall('/admin/alumnos', 'POST', {
                nombreUsuario: usuario,
                contrasena: pass,
                nombre: nombre,
                apellido: apellido,
                fechaNacimiento: fechaNacimiento
            });
        }

        function listarAlumnos() {
            apiCall('/admin/alumnos');
        }

        function actualizarAlumno() {
            const id = document.getElementById('alumnoId').value;
            const usuario = document.getElementById('alumnoNombreUsuario').value;
            const nombre = document.getElementById('alumnoNombre').value;
            const apellido = document.getElementById('alumnoApellido').value;
            const fechaNacimiento = document.getElementById('alumnoFechaNacimiento').value;
            const pass = document.getElementById('alumnoContrasena').value;

            apiCall(`/admin/alumnos/${id}`, 'PUT', {
                nombreUsuario: usuario,
                contrasena: pass,
                nombre: nombre,
                apellido: apellido,
                fechaNacimiento: fechaNacimiento
            });
        }

        function eliminarAlumno() {
            const id = document.getElementById('alumnoId').value;
            apiCall(`/admin/alumnos/${id}`, 'DELETE');
        }

        function verAlumnoPorId() {
            const id = document.getElementById('alumnoId').value;
            if (!id) { alert('Ingresa el ID del alumno'); return; }
            apiCall(`/alumno/${id}`, 'GET');
        }

    // ==========================
        // üîπ API Cursos
        // ==========================

        // Crear curso
        function crearCurso() {
            const nombre = document.getElementById('cursoNombre').value;
            const descripcion = document.getElementById('cursoDescripcion').value;
            const idDocente = document.getElementById('cursoDocenteId').value;
            apiCall('/cursos', 'POST', {
                nombreCurso: nombre,
                descripcion: descripcion,
                idDocente: idDocente
            });
        }

        // Listar todos los cursos
        function listarCursos() {
            apiCall('/cursos', 'GET');
        }

        // Actualizar curso
        function actualizarCurso() {
            const id = document.getElementById('cursoId').value;
            const nombre = document.getElementById('cursoNombre').value;
            const descripcion = document.getElementById('cursoDescripcion').value;
            const idDocente = document.getElementById('cursoDocenteId').value;
            apiCall(`/cursos/${id}`, 'PUT', {
                nombreCurso: nombre,
                descripcion: descripcion,
                idDocente: idDocente
            });
        }

        // Eliminar curso
        function eliminarCurso() {
            const id = document.getElementById('cursoId').value;
            apiCall(`/cursos/${id}`, 'DELETE');
        }

        // Listar cursos de un docente
        function listarCursosDocente() {
            const idDocente = document.getElementById('docenteCursoId').value.trim();

            if (!idDocente) {
                alert("Por favor, ingresa un ID de docente v√°lido.");
                return;
            }

            apiCall(`/cursos/docente/${idDocente}`, 'GET')
                .then(data => console.log("Cursos del docente:", data))
                .catch(err => console.error("Error al listar cursos:", err));
        }

        // Matricular alumno en un curso
        function matricularAlumno() {
            const idAlumno = document.getElementById('matriculaAlumnoId').value;
            const idCurso = document.getElementById('matriculaCursoId').value;

            apiCall('/cursos/matricular', 'POST', {
                idAlumnoFk: parseInt(idAlumno),
                idCursoFk: parseInt(idCurso)
            });
        }

        // Listar alumnos de un curso
        function listarAlumnosCurso() {
            const idCurso = document.getElementById('cursoAlumnosId').value.trim();

            if (!idCurso) {
                alert("Por favor, ingresa un ID de curso v√°lido.");
                return;
            }

            apiCall(`/cursos/${idCurso}/alumnos`, 'GET')
                .then(data => console.log("Alumnos del curso:", data))
                .catch(err => console.error("Error al listar alumnos:", err));
        }

        // Listar cursos de un alumno (cursos en los que est√° matriculado)
        function listarCursosAlumno() {
            const idAlumno = document.getElementById('alumnoCursosId').value.trim();

            if (!idAlumno) {
                alert("Por favor, ingresa un ID de alumno v√°lido.");
                return;
            }

            apiCall(`/cursos/alumno/${idAlumno}/cursos`, 'GET')
                .then(data => console.log("Cursos del alumno:", data))
                .catch(err => console.error("Error al listar cursos:", err));
        }

        // Listar alumnos de un docente (alumnos inscritos en cursos que dicta el docente)
        function listarAlumnosDocente() {
            const idDocente = document.getElementById('docenteAlumnosId').value.trim();

            if (!idDocente) {
                alert("Por favor, ingresa un ID de docente v√°lido.");
                return;
            }

            apiCall(`/cursos/docente/${idDocente}/alumnos`, 'GET')
                .then(data => console.log("Alumnos del docente:", data))
                .catch(err => console.error("Error al listar alumnos:", err));
        }


        // Test
        function obtenerPreguntas() {
            apiCall('/test/preguntas');
        }

        function completarTest() {
            const alumnoId = document.getElementById('testAlumnoId').value;
            const respuestas = JSON.parse(document.getElementById('testRespuestas').value);
            apiCall('/test/completar', 'POST', { idAlumno: parseInt(alumnoId), respuestas });
        }

        // Resultados
        function obtenerUltimoResultado() {
            const alumnoId = document.getElementById('resultadoAlumnoId').value;
            apiCall(`/alumno/${alumnoId}/resultados/ultimo`);
        }

        function obtenerHistorialResultados() {
            const alumnoId = document.getElementById('resultadoAlumnoId').value;
            apiCall(`/alumno/${alumnoId}/resultados/historial`);
        }

        function listarLogs() {
            apiCall('/admin/logs');
        }

        // ================= RESULTADOS DEL TEST =================
        
        function obtenerResultadosTest() {
            const alumnoId = document.getElementById('resultadosTestAlumnoId').value.trim();
            
            if (!alumnoId) {
                alert("Por favor, ingresa un ID de alumno v√°lido.");
                return;
            }
            
            apiCall(`/test/resultados/alumno/${alumnoId}`, 'GET')
                .then(data => {
                    if (data) {
                        // Mostrar el contenedor
                        document.getElementById('resultadosTestContainer').style.display = 'block';
                        
                        // Formatear y mostrar el JSON
                        const jsonFormateado = JSON.stringify(data, null, 2);
                        document.getElementById('resultadosTestDisplay').textContent = jsonFormateado;
                        
                        // Guardar los datos para poder copiarlos
                        window.resultadosTestData = jsonFormateado;
                        
                        showResponse(data);
                    }
                })
                .catch(err => {
                    alert('Error al obtener resultados: ' + (err.message || 'Error desconocido'));
                    console.error("Error al obtener resultados:", err);
                });
        }
        
        function copiarResultadosTest() {
            if (window.resultadosTestData) {
                navigator.clipboard.writeText(window.resultadosTestData).then(() => {
                    alert('‚úÖ Resultados copiados al portapapeles');
                }).catch(err => {
                    alert('Error al copiar: ' + err.message);
                });
            } else {
                alert('No hay resultados para copiar. Primero obt√©n los resultados de un alumno.');
            }
        }
        
        function crearResultadosTest() {
            const idIntento = document.getElementById('crearResultadoIdIntento').value.trim();
            const resultadosJson = document.getElementById('crearResultadoJson').value.trim();
            
            if (!idIntento) {
                alert('Por favor, ingresa el ID del intento');
                return;
            }
            
            if (!resultadosJson) {
                alert('Por favor, ingresa los resultados en formato JSON');
                return;
            }
            
            try {
                const resultados = JSON.parse(resultadosJson);
                
                // Validar estructura
                if (!Array.isArray(resultados)) {
                    throw new Error('Los resultados deben ser un array');
                }
                
                resultados.forEach((r, index) => {
                    if (!r.idInteligencia || r.puntajeCalculado === undefined) {
                        throw new Error(`El resultado en el √≠ndice ${index} debe tener "idInteligencia" y "puntajeCalculado"`);
                    }
                });
                
                const requestData = {
                    idIntento: parseInt(idIntento),
                    resultados: resultados
                };
                
                apiCall('/test/resultados', 'POST', requestData)
                    .then(data => {
                        alert('‚úÖ Resultados guardados exitosamente');
                        // Limpiar campos
                        document.getElementById('crearResultadoIdIntento').value = '';
                        document.getElementById('crearResultadoJson').value = '';
                    })
                    .catch(err => {
                        alert('Error al guardar resultados: ' + (err.message || 'Error desconocido'));
                        console.error("Error al guardar resultados:", err);
                    });
                    
            } catch (error) {
                alert('Error en el formato JSON: ' + error.message);
                console.error("Error al parsear JSON:", error);
            }
        }

        // ================= CHAT CON IA =================
        let currentSessionId = null;
        let chatType = 'individual'; // 'individual' o 'grupal'
        let autoRefreshInterval = null;
        let lastSessionIdBeforeCreate = null; // Para detectar reutilizaci√≥n

        function seleccionarTipoChat(tipo) {
            chatType = tipo;
            document.getElementById('btnChatIndividual').classList.toggle('active', tipo === 'individual');
            document.getElementById('btnChatGrupal').classList.toggle('active', tipo === 'grupal');
            document.getElementById('chatIndividualConfig').style.display = tipo === 'individual' ? 'block' : 'none';
            document.getElementById('chatGrupalConfig').style.display = tipo === 'grupal' ? 'block' : 'none';
        }

        // Funci√≥n para cargar la √∫ltima sesi√≥n autom√°ticamente (comportamiento por defecto)
        function cargarUltimaSesion() {
            const docenteId = document.getElementById('chatDocenteId').value;
            
            if (!docenteId) {
                alert('Por favor, ingresa el ID del docente');
                return;
            }
            
            // Para chats individuales: buscar √∫ltima sesi√≥n
            if (chatType === 'individual') {
                const alumnoId = document.getElementById('chatAlumnoId').value;
                if (!alumnoId) {
                    alert('Por favor, ingresa el ID del alumno');
                    return;
                }
                
                // Mostrar indicador de carga
                const btnCargar = document.querySelector('button[onclick="cargarUltimaSesion()"]');
                const btnTextOriginal = btnCargar.textContent;
                btnCargar.disabled = true;
                btnCargar.textContent = '‚è≥ Cargando...';
                
                // Buscar √∫ltima sesi√≥n
                apiCall(`/chat/sesiones/docente/${docenteId}/alumno/${alumnoId}/ultima`, 'GET')
                    .then(data => {
                        if (data && data.idSesion) {
                            // √öltima sesi√≥n encontrada
                            currentSessionId = data.idSesion;
                            document.getElementById('sesionId').value = data.idSesion;
                            
                            // Mostrar informaci√≥n de sesi√≥n
                            document.getElementById('sessionInfoText').textContent = 
                                `Sesi√≥n #${data.idSesion} - Chat Individual`;
                            document.getElementById('chatSessionInfo').style.display = 'block';
                            
                            document.getElementById('chatContainer').style.display = 'flex';
                            document.getElementById('chatTitle').textContent = `üí¨ ${data.tituloSesion || 'Consulta Individual'}`;
                            
                            // Cargar mensajes
                            obtenerMensajes().then(mensajes => {
                                const reuseInfo = document.getElementById('chatSessionReuseInfo');
                                const reuseText = document.getElementById('sessionReuseText');
                                
                                if (mensajes && mensajes.length > 0) {
                                    // Sesi√≥n encontrada con mensajes
                                    reuseInfo.className = 'chat-session-reuse';
                                    reuseText.innerHTML = `üîÑ <strong>Sesi√≥n cargada:</strong> Se encontr√≥ la √∫ltima sesi√≥n activa. Se cargaron ${mensajes.length} mensajes del historial.`;
                                    reuseInfo.style.display = 'block';
                                } else {
                                    // Sesi√≥n encontrada pero sin mensajes
                                    reuseInfo.className = 'chat-session-new';
                                    reuseText.innerHTML = '‚ú® <strong>Sesi√≥n encontrada:</strong> Se encontr√≥ una sesi√≥n previa, pero no tiene mensajes.';
                                    reuseInfo.style.display = 'block';
                                    mostrarMensajeBienvenida();
                                }
                            });
                            
                            iniciarAutoRefresh();
                        } else {
                            // No se encontr√≥ sesi√≥n, preguntar si crear nueva
                            if (confirm('No se encontr√≥ una sesi√≥n previa. ¬øDeseas crear una nueva sesi√≥n?')) {
                                crearNuevaSesion();
                            }
                        }
                    })
                    .catch(error => {
                        // Si no se encuentra (404), ofrecer crear nueva
                        if (error.status === 404 || error.message?.includes('404')) {
                            if (confirm('No se encontr√≥ una sesi√≥n previa. ¬øDeseas crear una nueva sesi√≥n?')) {
                                crearNuevaSesion();
                            }
                        } else {
                            alert('Error al cargar sesi√≥n: ' + (error.message || 'Error desconocido'));
                            console.error('Error al cargar sesi√≥n:', error);
                        }
                    })
                    .finally(() => {
                        btnCargar.disabled = false;
                        btnCargar.textContent = btnTextOriginal;
                    });
            } else {
                // Para chats grupales, usar crearSesion normal
                crearNuevaSesion();
            }
        }
        
        // Funci√≥n para crear una nueva sesi√≥n (fuerza creaci√≥n)
        function crearNuevaSesion() {
            const docenteId = document.getElementById('chatDocenteId').value;
            const titulo = document.getElementById('chatTitulo').value;
            
            if (!docenteId) {
                alert('Por favor, ingresa el ID del docente');
                return;
            }
            
            // Generar t√≠tulo por defecto si no hay
            const tituloFinal = titulo.trim() || (chatType === 'individual' 
                ? 'Consulta Individual' 
                : 'Consulta Grupal');
            
            const requestData = {
                idDocente: parseInt(docenteId),
                tituloSesion: tituloFinal
            };
            
            if (chatType === 'individual') {
                const alumnoId = document.getElementById('chatAlumnoId').value;
                if (!alumnoId) {
                    alert('Por favor, ingresa el ID del alumno');
                    return;
                }
                requestData.idAlumno = parseInt(alumnoId);
                requestData.idCurso = null;
            } else {
                const cursoId = document.getElementById('chatCursoId').value;
                if (!cursoId) {
                    alert('Por favor, ingresa el ID del curso');
                    return;
                }
                requestData.idCurso = parseInt(cursoId);
                requestData.idAlumno = null;
            }
            
            // Mostrar indicador de carga
            const btnCrear = document.querySelector('button[onclick="crearNuevaSesion()"]');
            const btnTextOriginal = btnCrear ? btnCrear.textContent : '‚ûï Crear Nueva Sesi√≥n';
            if (btnCrear) {
                btnCrear.disabled = true;
                btnCrear.textContent = '‚è≥ Creando...';
            }
            
            // Forzar creaci√≥n de nueva sesi√≥n (no reutilizar)
            requestData.forzarCreacion = true;
            
            apiCall('/chat/sesiones', 'POST', requestData).then(data => {
                if (data && data.idSesion) {
                    currentSessionId = data.idSesion;
                    document.getElementById('sesionId').value = data.idSesion;
                    
                    // Mostrar informaci√≥n de sesi√≥n
                    document.getElementById('sessionInfoText').textContent = 
                        `Sesi√≥n #${data.idSesion} - ${chatType === 'individual' ? 'Chat Individual' : 'Chat Grupal'}`;
                    document.getElementById('chatSessionInfo').style.display = 'block';
                    
                    document.getElementById('chatContainer').style.display = 'flex';
                    document.getElementById('chatTitle').textContent = `üí¨ ${data.tituloSesion || tituloFinal}`;
                    
                    // Cargar mensajes
                    obtenerMensajes().then(mensajes => {
                        const reuseInfo = document.getElementById('chatSessionReuseInfo');
                        const reuseText = document.getElementById('sessionReuseText');
                        
                        const tieneMensajesPrevios = mensajes && mensajes.length > 0;
                        
                        // Nueva sesi√≥n (forzada)
                        reuseInfo.className = 'chat-session-new';
                        reuseText.innerHTML = '‚ú® <strong>Nueva sesi√≥n creada:</strong> Esta es una conversaci√≥n nueva.';
                        reuseInfo.style.display = 'block';
                        if (!tieneMensajesPrevios) {
                            mostrarMensajeBienvenida();
                        }
                    });
                    
                    iniciarAutoRefresh();
                }
            })
            .catch(error => {
                alert('Error al crear sesi√≥n: ' + (error.message || 'Error desconocido'));
                console.error('Error al crear sesi√≥n:', error);
            })
            .finally(() => {
                if (btnCrear) {
                    btnCrear.disabled = false;
                    btnCrear.textContent = btnTextOriginal;
                }
            });
        }

        function mostrarMensajeBienvenida() {
            const mensaje = {
                emisor: 'ia',
                contenido: chatType === 'individual' 
                    ? '¬°Hola! Soy tu asistente educativo. Estoy listo para ayudarte a interpretar y aplicar los resultados del test de inteligencias m√∫ltiples del estudiante. ¬øEn qu√© puedo ayudarte?'
                    : '¬°Hola! Soy tu asistente educativo. Estoy listo para ayudarte con estrategias pedag√≥gicas grupales basadas en el perfil de inteligencias del curso. ¬øEn qu√© puedo ayudarte?',
                fechaHoraEnvio: new Date().toISOString()
            };
            agregarMensajeAlChat(mensaje);
        }

        function cargarSesionExistente() {
            const sesionId = document.getElementById('sesionId').value;
            if (!sesionId) {
                alert('Por favor, ingresa el ID de la sesi√≥n');
                return;
            }
            
            // Mostrar indicador de carga
            const btnCargar = document.querySelector('button[onclick="cargarSesionExistente()"]');
            const btnTextOriginal = btnCargar.textContent;
            btnCargar.disabled = true;
            btnCargar.textContent = '‚è≥ Cargando...';
            
            apiCall(`/chat/sesiones/${sesionId}`).then(data => {
                if (data && data.idSesion) {
                    currentSessionId = data.idSesion;
                    document.getElementById('chatTitle').textContent = `üí¨ ${data.tituloSesion}`;
                    document.getElementById('chatContainer').style.display = 'flex';
                    document.getElementById('sessionInfoText').textContent = 
                        `Sesi√≥n #${data.idSesion} - ${data.idAlumno ? 'Chat Individual' : 'Chat Grupal'}`;
                    document.getElementById('chatSessionInfo').style.display = 'block';
                    
                    // Ocultar indicador de reutilizaci√≥n (si estaba visible)
                    document.getElementById('chatSessionReuseInfo').style.display = 'none';
                    
                    // Cargar mensajes
                    obtenerMensajes().then(mensajes => {
                        if (mensajes.length === 0) {
                            mostrarMensajeBienvenida();
                        }
                    });
                    
                    iniciarAutoRefresh();
                }
            })
            .catch(error => {
                alert('Error al cargar sesi√≥n: ' + (error.message || 'Error desconocido'));
                console.error('Error al cargar sesi√≥n:', error);
            })
            .finally(() => {
                btnCargar.disabled = false;
                btnCargar.textContent = btnTextOriginal;
            });
        }

        function obtenerSesion() {
            const sesionId = document.getElementById('sesionId').value;
            if (!sesionId) {
                alert('Por favor, ingresa el ID de la sesi√≥n');
                return;
            }
            apiCall(`/chat/sesiones/${sesionId}`);
        }

        function obtenerMensajes() {
            if (!currentSessionId) {
                const sesionId = document.getElementById('sesionId').value;
                if (!sesionId) {
                    alert('Por favor, crea o carga una sesi√≥n primero');
                    return Promise.resolve();
                }
                currentSessionId = sesionId;
            }
            
            return apiCall(`/chat/sesiones/${currentSessionId}/mensajes`).then(data => {
                if (Array.isArray(data)) {
                    displayMessages(data);
                    return data;
                }
                return [];
            }).catch(error => {
                console.error('Error al obtener mensajes:', error);
                return [];
            });
        }

        function enviarMensaje() {
            if (!currentSessionId) {
                alert('Por favor, crea o carga una sesi√≥n primero');
                return;
            }
            
            const contenido = document.getElementById('mensajeContenido').value.trim();
            if (!contenido) {
                return;
            }
            
            // Mostrar mensaje del usuario inmediatamente
            const mensajeUsuario = {
                emisor: 'docente',
                contenido: contenido,
                fechaHoraEnvio: new Date().toISOString()
            };
            agregarMensajeAlChat(mensajeUsuario);
            
            // Limpiar input
            document.getElementById('mensajeContenido').value = '';
            ajustarAlturaInput();
            
            // Deshabilitar bot√≥n mientras se procesa
            const btnEnviar = document.getElementById('btnEnviarChat');
            btnEnviar.disabled = true;
            
            // Mostrar indicador de carga
            mostrarIndicadorCarga();
            
            // Enviar mensaje
            apiCall(`/chat/sesiones/${currentSessionId}/mensajes`, 'POST', { contenido })
                .then(data => {
                    if (data && data.idMensaje) {
                        obtenerMensajes(); 
                    }
                })
                .catch(error => {
                    ocultarIndicadorCarga();
                    btnEnviar.disabled = false;
                    alert('Error al enviar mensaje: ' + error.message);
                })
                .finally(() => {
                    ocultarIndicadorCarga();
                    btnEnviar.disabled = false;
                });
        }

        function displayMessages(messages) {
            const chatArea = document.getElementById('chatMessages');
            
            if (!messages || messages.length === 0) {
                chatArea.innerHTML = 
                    '<div style="text-align: center; color: #999; padding: 40px;"><p>üí° Escribe un mensaje para comenzar la conversaci√≥n</p></div>';
                return;
            }
            
            chatArea.innerHTML = '';
            messages.forEach(msg => {
                agregarMensajeAlChat(msg);
            });
            
            // Scroll al final
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function agregarMensajeAlChat(msg) {
            const chatArea = document.getElementById('chatMessages');
            
            // Remover mensaje de bienvenida si existe
            const welcomeMsg = chatArea.querySelector('div[style*="text-align: center"]');
            if (welcomeMsg) {
                welcomeMsg.remove();
            }
            
            const div = document.createElement('div');
            div.className = `chat-message ${msg.emisor}`;
            
            const avatar = msg.emisor === 'docente' ? 'üë§' : 'ü§ñ';
            const nombre = msg.emisor === 'docente' ? 'Docente' : 'IA';
            const fecha = new Date(msg.fechaHoraEnvio).toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.innerHTML = `
                <div class="chat-message-avatar">${avatar}</div>
                <div class="chat-message-content">
                    <div class="chat-message-text">${escapeHtml(msg.contenido)}</div>
                    <div class="chat-message-time">${fecha}</div>
                </div>
            `;
            
            chatArea.appendChild(div);
            
            // Scroll suave al final
            setTimeout(() => {
                chatArea.scrollTo({
                    top: chatArea.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        function mostrarIndicadorCarga() {
            const chatArea = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chatLoadingIndicator';
            loadingDiv.className = 'chat-message ia';
            loadingDiv.innerHTML = `
                <div class="chat-message-avatar">ü§ñ</div>
                <div class="chat-message-content">
                    <div class="chat-loading">
                        <div class="chat-loading-dot"></div>
                        <div class="chat-loading-dot"></div>
                        <div class="chat-loading-dot"></div>
                        <span style="margin-left: 8px;">La IA est√° pensando...</span>
                    </div>
                </div>
            `;
            chatArea.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function ocultarIndicadorCarga() {
            const loadingDiv = document.getElementById('chatLoadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                enviarMensaje();
            }
        }

        function ajustarAlturaInput() {
            const input = document.getElementById('mensajeContenido');
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 150) + 'px';
        }
        function iniciarAutoRefresh() {
            // Si ya hay un intervalo activo, detenerlo antes de iniciar otro
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                console.log('‚èπ Intervalo anterior detenido');
            }
        
            // Evitar iniciar si no hay sesi√≥n activa
            if (!currentSessionId) {
                console.warn('‚ö†Ô∏è No hay sesi√≥n activa para auto-refresh');
                return;
            }
        
            console.log('üîÅ Auto-refresh iniciado para sesi√≥n', currentSessionId);
        
            // Crear un √∫nico intervalo
            autoRefreshInterval = setInterval(() => {
                obtenerMensajes();
            }, 90000); // 90 segundos (aj√∫stalo si quieres)
        }
        
        function cerrarChat() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('üßπ Intervalo limpiado al cerrar chat');
            }
            document.getElementById('chatContainer').style.display = 'none';
            document.getElementById('chatSessionReuseInfo').style.display = 'none';
            currentSessionId = null;
            lastSessionIdBeforeCreate = null;
        }
        
        function limpiarChat() {
            document.getElementById('chatMessages').innerHTML = 
                '<div style="text-align: center; color: #999; padding: 40px;"><p>üí° Escribe un mensaje para comenzar la conversaci√≥n</p></div>';
            document.getElementById('mensajeContenido').value = '';
            ajustarAlturaInput();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ================= FUNCIONES ADICIONALES DE CHAT =================
        
        function listarSesionesPorDocente() {
            const docenteId = document.getElementById('chatDocenteIdConsulta').value.trim();
            if (!docenteId) {
                alert('Por favor, ingresa el ID del docente');
                return;
            }
            apiCall(`/chat/sesiones/docente/${docenteId}`, 'GET')
                .then(data => {
                    if (Array.isArray(data)) {
                        showResponse(data);
                        alert(`Se encontraron ${data.length} sesiones`);
                    }
                })
                .catch(err => {
                    alert('Error al listar sesiones: ' + (err.message || 'Error desconocido'));
                    console.error("Error al listar sesiones:", err);
                });
        }
        
        function listarSesionesPorCurso() {
            const cursoId = document.getElementById('chatCursoIdConsulta').value.trim();
            if (!cursoId) {
                alert('Por favor, ingresa el ID del curso');
                return;
            }
            apiCall(`/chat/sesiones/curso/${cursoId}`, 'GET')
                .then(data => {
                    if (Array.isArray(data)) {
                        showResponse(data);
                        alert(`Se encontraron ${data.length} sesiones`);
                    }
                })
                .catch(err => {
                    alert('Error al listar sesiones: ' + (err.message || 'Error desconocido'));
                    console.error("Error al listar sesiones:", err);
                });
        }
        
        function listarSesionesPorAlumno() {
            const alumnoId = document.getElementById('chatAlumnoIdConsulta').value.trim();
            if (!alumnoId) {
                alert('Por favor, ingresa el ID del alumno');
                return;
            }
            apiCall(`/chat/sesiones/alumno/${alumnoId}`, 'GET')
                .then(data => {
                    if (Array.isArray(data)) {
                        showResponse(data);
                        alert(`Se encontraron ${data.length} sesiones`);
                    }
                })
                .catch(err => {
                    alert('Error al listar sesiones: ' + (err.message || 'Error desconocido'));
                    console.error("Error al listar sesiones:", err);
                });
        }
        
        function actualizarMensajeChat() {
            const mensajeId = document.getElementById('mensajeIdEditar').value.trim();
            const contenido = document.getElementById('mensajeContenidoEditar').value.trim();
            
            if (!mensajeId) {
                alert('Por favor, ingresa el ID del mensaje');
                return;
            }
            
            if (!contenido) {
                alert('Por favor, ingresa el nuevo contenido del mensaje');
                return;
            }
            
            apiCall(`/chat/mensajes/${mensajeId}`, 'PUT', { contenido })
                .then(data => {
                    alert('‚úÖ Mensaje actualizado exitosamente');
                    document.getElementById('mensajeIdEditar').value = '';
                    document.getElementById('mensajeContenidoEditar').value = '';
                    showResponse(data);
                })
                .catch(err => {
                    alert('Error al actualizar mensaje: ' + (err.message || 'Error desconocido'));
                    console.error("Error al actualizar mensaje:", err);
                });
        }
        
        function eliminarMensajeChat() {
            const mensajeId = document.getElementById('mensajeIdEliminar').value.trim();
            
            if (!mensajeId) {
                alert('Por favor, ingresa el ID del mensaje');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este mensaje?')) {
                return;
            }
            
            apiCall(`/chat/mensajes/${mensajeId}`, 'DELETE')
                .then(() => {
                    alert('‚úÖ Mensaje eliminado exitosamente');
                    document.getElementById('mensajeIdEliminar').value = '';
                    showResponse({ message: 'Mensaje eliminado' });
                })
                .catch(err => {
                    alert('Error al eliminar mensaje: ' + (err.message || 'Error desconocido'));
                    console.error("Error al eliminar mensaje:", err);
                });
        }

        // ================= DOCENTE - RESULTADOS DE ALUMNOS =================
        
        function obtenerResultadosAlumnoDocente() {
            const alumnoId = document.getElementById('docenteResultadoAlumnoId').value.trim();
            
            if (!alumnoId) {
                alert('Por favor, ingresa el ID del alumno');
                return;
            }
            
            apiCall(`/docente/alumnos/${alumnoId}/resultados`, 'GET')
                .then(data => {
                    if (Array.isArray(data)) {
                        showResponse(data);
                        alert(`Se encontraron ${data.length} resultados`);
                    }
                })
                .catch(err => {
                    alert('Error al obtener resultados: ' + (err.message || 'Error desconocido'));
                    console.error("Error al obtener resultados:", err);
                });
        }

        // Ajustar altura del textarea autom√°ticamente
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('mensajeContenido');
            if (input) {
                input.addEventListener('input', ajustarAlturaInput);
            }
        });
    </script>
</body>
</html>

